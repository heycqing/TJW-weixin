## 🎮 nodeJs开发微信公众号

### 目录
 1. [微信公众号后台开发原理](#微信公众号开发原理)
 9. [如何运行线上和测试环境](#运行环境)
 10. [版本变迁](#版本变迁)


### 微信公众号后台开发原理

**流程图主要分为3步**

1. 第一步：填写服务器配置
2. 第二步：验证消息的确来自微信服务器
3. 第三步：根据业务逻辑选择接口编写代码

> 这里我会分装好第二步，主要是确认消息是来自微信服务器;<br>
> 关键是验证消息，只要验证消息通过，下面的业务处理就简单了;<br>
> 同时还需要保证每两个小时更新一下验证消息。

第二步的具体流程:

1. 将 `token、timestamp、nonce` 三个参数进行字典序排序;
2. 将三个参数字符串拼接成一个字符串进行`sha1`加密;
3. 开发者获得加密后的字符串可与 `signature` 对比，标识该请求来源于微信;

**注意事项：**
1. 请求使用 `get` 方法；




[具体参考微信公众号开发文档](https://mp.weixin.qq.com/wiki?t=resource/res_main&id=mp1445241432)

### 运行环境

> 分别是线上和测试环境

1. **在测试环境运行，可以通过localtunnel来进行外网映射**
 
    + 1.1 安装**localtunnel**

    ```npm install -g localtunnel ```
    
    + 1.2 启动服务

        - 1.2.1 在根目录启动 `app.js `

            ``` node app.js ```

        + 1.2.2 然后，启动 映射服务 

            ```lt --port 5544(端口号) ```

        + 1.2.3 在微信测试号配置好 **链接**

    + 1.3 进入测试公众号进行测试；
    

2. **如何正确部署线上环境？**

    对于 `nodeJs` 来讲想要对 `微信公众号` 进行开发，只能监听 `80端口或者433端口`，但是 `node应用` 监听 `80端口` 的话，服务器只能监听其他端口，可能会导致一些其他的问题，为了避免这些问题和解决单用`测试环境`的做法所导致链接不稳定问题，这里推荐解决办法是： **使用nginx为node应用做反向代理**

    > 做法：
    + 2.1 服务器必须是： `nginx`;
    + 2.2 对 `nginx` 的配置文件做修：
        + 2.2.1 `nginx` 配置文件路径:
            <br>
            一般情况下：
            ``` /etc/nginx/nginx.conf ``
        + 2.2.2 `nginx` 配置文件修改：   
        ```js
            server {
                listen   3000(端口号);    
     
                location / {
                    proxy_pass 代理网址;
                }

            }
        ```


### 版本变迁
1. V 1.0.0 
    + 是一个具体的项目，但是代码不够简洁；
    + 链接不稳定；
    + 没有定时获取`access_token`,获取函数失效；
    + 没用的代码文件过于繁杂；

2. V 1.1.0 
    + 精简代码；
    + 使用反向代理稳定链接；
    + 定时获取`access_token`；
    + 删除整理没用代码；

